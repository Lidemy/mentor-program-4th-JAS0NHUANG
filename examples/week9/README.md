# Week9 作業自我檢討

## 關於驗證

以前我們在寫 JS 的時候有寫過表單驗證，這週 PHP 我們從後端來進行一些資料的驗證，這兩種到底差在哪邊呢？

關於驗證欄位的方式，仔細想想你會發現其實真的必備的只有一個，其他都是增進使用者體驗。

必備的是 PHP 後端那邊的驗證。

為什麼呢？假設只有前端驗證，是沒有用的，仔細想想第四週的內容，就算前端有驗證，我還是可以直接寫一個 node.js 程式發送資料給 PHP，依舊可以傳壞掉的資料。

因此，後端的驗證是必備的，才能真正防止不合法的資料寫進資料庫。

前端只是為了增進使用者體驗，不用去到後端發現錯誤才回來，而是在前端 submit 時就能夠找到錯誤並顯示出來。所以要多少驗證，端看你想要達成怎樣的使用者體驗。

### 注意，以下內容是參考解答，還沒寫完請不要看喔！

.  
.  
.  
.  
.  
.  
.   
.  
.  
.  
.  
.  

## 資料庫欄位型態 VARCHAR 跟 TEXT 的差別是什麼

網路上查可以查到很多相關資料，但我個人覺得最重要的一個點在於 VARCHAR 可以設長度但是 TEXT 不行。

意思就是說，當你本來就知道大概會需要多少字元的時候，就用 VARCHAR，真的逼不得已東西很長（例如說要存文章）的時候才用 TEXT，才能節省空間。

## Cookie 跟 Session 不要搞混了

這週其實還沒講到 Session 的概念，為的其實就是希望大家不要搞混。但因為之前 CS101 火球術其實已經提到了，所以反而有點弄巧成拙（？），還是滿多人搞混的。

請大家注意這一週作業問的問題：

> Cookie 是什麼？在 HTTP 這一層要怎麼設定 Cookie，瀏覽器又會以什麼形式帶去 Server？

如果是我的話大概會這樣答：

Cookie 是個儲存在瀏覽器的小型文字檔案，在 HTTP 這層 Server 可以透過 Set-Cookie 這個 response header 來讓瀏覽器儲存相對應的 Cookie。而瀏覽器發送 Request 時，會把相對應的 Cookie 放在 `Cookie` 這個 Header，Server 就可以拿到資料。

「相對應的」指的是每一個 Cookie 都有一些選項可以設置，要符合條件才能寫入以及傳送，例如說你無法寫入其他 domain 的 cookie。

所以我這邊在談的是 Cookie 的本質：儲存資料。而另一個重點就是伺服器可以把資料寫在 Cookie，瀏覽器也會幫你把 Cookie 帶給伺服器。

至於其他用途（廣告追蹤、身份驗證）那都是再延伸出去的東西了，其實不是這題的重點。可以當作額外補充，但你要知道的是 Cookie 本身就是個儲存容器，身份驗證是其中的用途之一，但還有其他用途。

## 來自 client 端的資料都不可信

大家千萬不要忘記一件事情了，千萬不要忘記什麼是我們可以自己改的，什麼不行。你要站在攻擊者的角度去想什麼東西可以被偽造。

GET 跟 POST 的參數值可不可以被偽造？當然可以！我想傳什麼就傳什麼，本來就沒有限制。

Cookie 的內容可不可以被偽造？當然可以，這也是我想帶什麼就帶什麼。

資料庫的值可不可以被偽造？可以，但如果被偽造的話就代表你資料庫已經被駭客拿下了，所以不用擔心這個問題。

所以為什麼這週曾經做過的會員系統不 ok？因為我們把會員 id 帶在 cookie，今天只要攻擊者自己改變 cookie 內容（可不可以？當然可以），就可以換一個身份登入，所以是有安全漏洞的。

這也是為什麼這一週要換成通行證機制，比起會員 id，我們隨機產生的通行證 id 是沒辦法被猜到的。那攻擊者可不可以竄改通行證 id？當然可以，他可以自己改變 cookie 的值，可是他要改成什麼？

通行證 id 是隨機產生的，他怎麼可能隨便猜就猜得到一組正確的？

所以在這情景下你不用去考慮什麼「如果他用別人的通行證，不就也可以利用別人的身份登入嗎？」，對啊，當然，但這個機制本來就只認證不認人，用別人的通行證本來就應該用別人的身份登入。

今天的重點是攻擊者沒辦法「拿到別人的通行證」或者是猜到，所以這個機制還是可靠的。

有些人作業把通行證的產生規則弄固定了，就是多此一舉。例如說通行證就是 `md5(username)`，一但這個規則被猜到了，我不就也可以產生出別人的通行證嗎？那這機制就沒用了。

所以我才強調要隨機產生，隨機就代表猜不到（精確一點的說法是很難猜啦，例如說機率是兩億分之一，就可以想成猜不到）

然後，這個通行證機制就叫做 Session。

你產生的通行證 ID 就是 session id，你在 users_certificate 這個 table 放的資料就是 session data。

那 $_SESSION 又是什麼？跟 session 有什麼關係？

在回答這個之前，先問你一個問題：

> cookie 跟 $_COOKIE 有什麼關係？

Cookie 是瀏覽器存資料的地方，它是一個 browser 跟 server 交換資料的機制。而 $_COOKIE 是 PHP 要用來操作 cookie 時的語法。

session 也是一樣的。

Session 就是通行證機制，可以在 server 端存放資料，在 client 端只透過 session id 來驗證身份；而 $_SESSION 是 PHP 用來操作 session 時的語法。

session 只是個機制，就像是投票那樣。但它本身不會規定投票要怎麼投。你可以每個人發紙條寫要投誰；你可以線上電子投票；你可以在想投的箱子放一個球，這些都叫做投票。

session 也是一樣的，這個機制也能有很多不同的實作方式，你可以像我們一樣自己用 users_certificate 這個 table 來實作，也可以用 PHP 內建的 $_SESSION 來實作，這些都叫做 session，只是實作方法不同。

更多細節可以參考 Session 與 Cookie 三部曲：

1. [白話 Session 與 Cookie：從經營雜貨店開始](https://github.com/aszx87410/blog/issues/45)
2. [淺談 Session 與 Cookie：一起來讀 RFC](https://github.com/aszx87410/blog/issues/45)
3. [深入 Session 與 Cookie：Express、PHP 與 Rails 的實作](https://github.com/aszx87410/blog/issues/46)

## 這週會碰到的問題

這週的作業主要會碰到的問題有兩個（當然還有更多啦，先提兩個）：

1. 密碼存明碼，當駭客入侵把你資料庫偷走之後，你家會員的密碼就全部被駭客知道了，解法在之後會講。
2. 利用 cookie 裡的 user id 來判斷登入的人是誰，我只要把 cookie 裡面的值一改掉，就可以偽造別人身份登入，所以後來才需要改成 session 機制。
